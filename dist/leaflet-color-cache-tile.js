!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("leaflet"),require("idb-keyval")):"function"==typeof define&&define.amd?define(["leaflet","idb-keyval"],t):t(e||self,e.idbKeyval)}(this,function(e,t){var i=/*#__PURE__*/function(){function e(e,t){this.cacheMap=new Map,this.time=Math.floor((new Date).valueOf()/1e3),this.name="cache_tile_name",this.overdue=void 0,e&&(this.name=e),this.overdue=t,this.init()}var i=e.prototype;return i.init=function(){try{var e=this;return Promise.resolve(e.checkDatabase()).then(function(t){return t&&(e.cacheMap=t),Promise.resolve(e.cacheMap)})}catch(e){return Promise.reject(e)}},i.getTile=function(e){return this.cacheMap.get(e)},i.setTile=function(e,t,i){void 0===i&&(i=!1);var o=this.cacheMap;i?o.set(e,t):o.has(e)||o.set(e,t),this.updateDatabase()},i.checkDatabase=function(){try{var e=this;return Promise.resolve(t.get(e.name)).then(function(i){var o=(new Date).valueOf()/1e3;return i?"NO"===i.time||i.time>o?i.data:(t.del(e.name),null):null})}catch(e){return Promise.reject(e)}},i.updateDatabase=function(e){try{var i=this;return void 0===e&&(e=i.cacheMap),Promise.resolve(t.set(i.name,{data:e,time:i.getCacheTime()})).then(function(){})}catch(e){return Promise.reject(e)}},i.getCacheTime=function(){var e=this.overdue;return!e||"number"==typeof e&&e<0?"NO":+this.time+ +e},e}();if(!L)throw new Error("please install leaflet which >1.0.0 to use the plugins");var o={},r=L.GridLayer.prototype._initTile,n=L.TileLayer.prototype.initialize,a=L.TileLayer.prototype.createTile,c=L.TileLayer.extend({initialize:function(e,t){var r=this;t=L.extend({},L.TileLayer.prototype.options,{colorize:function(e){return e},cacheSet:function(e){return void 0===e&&(e={}),e},crossOrigin:"Anonymous"},t),n.call(this,e,t),L.setOptions(this,t);var a=t.cacheSet({}),c=a.name||i.name;o[c]=new i(c,a.time),this.setColorizr(t.colorize),this.setCacheOptions(t.cacheSet),this.on("tileload",function(e){var t=Object.values(e.coords).join(":");r._colorize(e.tile,c+"/"+t)})},setColorizr:function(e){if(!e||"function"!=typeof e)throw'The colorize option should be a function and return an object with at least one of "r", "g", "b", or "a" properties. Got:'+typeof e;this.options.colorize=e,this.redraw(!1)},setCacheOptions:function(e){if(!e||"function"!=typeof e)throw'The cacheSet option should be a function and return an object with at least one of "name", "time" properties. Got:'+typeof e;this.options.cacheSet=e,this.redraw(!1)},_initTile:function(e){r.call(this,e);var t=this.getTileSize();e.style.width=t.x+1+"px",e.style.height=t.y+1+"px"},createTile:function(e,t){var r=a.call(this,e,t);r.crossOrigin="Anonymous";var n=Object.values(e).join(":"),c=this.options.cacheSet({}).name||i.name,s=c+"/"+n,h=o[c].getTile(s);return h?(r.src=h,r.setAttribute("color-cache-loaded","true")):(r.hidden=!0,r.src=this.getTileUrl(e),o[c].init().then(function(e){if(e.size){var i=o[c].getTile(s);i&&(r.src=i,r.setAttribute("color-cache-loaded","true"))}t(void 0,r)})),r},_colorize:function(e,t){var r=this;if(e.getAttribute("color-cache-loaded"))e.hidden=!1;else{e.hidden=!0;var n=e,a=new Image;a.crossOrigin="Anonymous",a.src=n.src,a.onload=function(){var e=document.createElement("canvas");e.width=a.width,e.height=a.height;var c=e.getContext("2d");c.drawImage(a,0,0);for(var s=c.getImageData(0,0,e.width,e.height),h=s.data,l=0,u=h.length;l<u;l+=4){var f=r.options.colorize({r:h[l],g:h[l+1],b:h[l+2],a:h[l+3]});if(f&&f===Object(f)&&"[object Array]"!==Object.prototype.toString.call(f))f.hasOwnProperty("r")&&"number"==typeof f.r&&(h[l]=f.r),f.hasOwnProperty("g")&&(h[l+1]=f.g),f.hasOwnProperty("b")&&(h[l+2]=f.b),f.hasOwnProperty("a")&&(h[l+3]=f.a);else if(0===l)throw'The colorize option should return an object with at least one of "r", "g", "b", or "a" properties.'}c.putImageData(s,0,0),n.setAttribute("color-cache-loaded","true");var d=e.toDataURL("image/webp",.8);n.src=d;var p=r.options.cacheSet({}).name||i.name;o[p].setTile(t,d)}}}});L.colorCacheTile=function(e,t){return new c(e,t)}});
