{"version":3,"file":"leaflet-color-cache-tile.modern.mjs","sources":["../src/CacheTool.ts","../src/main.ts"],"sourcesContent":["import { del, get, set } from 'idb-keyval';\n\ntype CacheDataMap = Map<string, string>;\n\nexport default class CacheTile {\n  private cacheMap: CacheDataMap = new Map();\n\n  // private time = Math.floor(new Date().valueOf() / 1000)\n  private time = Math.floor(new Date().valueOf() / 1000);\n\n  private name = 'cache_tile_name';\n\n  private overdue: number | boolean | undefined;\n\n  /**\n   *\n   * @param {string} name 储存某一类的数据名称\n   * @param {number | boolean} overdue 过期时间(s)/是否过期\n   */\n  constructor(name: string, overdue?: number | boolean) {\n    if (name) {\n      this.name = name;\n    }\n    this.overdue = overdue;\n\n    this.init();\n  }\n  // 初始化\n  async init(): Promise<CacheDataMap> {\n    const data = await this.checkDatabase();\n    if (data) {\n      this.cacheMap = data;\n    }\n    return Promise.resolve(this.cacheMap);\n  }\n  // 通过key获取map数据\n  getTile(key: string): string | undefined {\n    return this.cacheMap.get(key);\n  }\n  // 设置map数据\n  setTile(key: string, value: string, upload = false):void {\n    const { cacheMap } = this;\n    if (upload) {\n      cacheMap.set(key, value);\n    } else {\n      if (!cacheMap.has(key)) {\n        cacheMap.set(key, value);\n      }\n    }\n\n    this.updateDatabase();\n  }\n  // 检查并获取数据\n  async checkDatabase(): Promise<CacheDataMap | null> {\n    const data = await get(this.name);\n    const _time = new Date().valueOf() / 1000;\n    if (data) {\n      if (data.time === 'NO' || data.time > _time) {\n        return data.data;\n      }\n      del(this.name);\n      return null;\n    }\n    return null;\n  }\n  // 更新数据\n  async updateDatabase(data = this.cacheMap): Promise<void> {\n    const { name } = this;\n    await set(name, {\n      data,\n      time: this.getCacheTime()\n    });\n  }\n  // 时间过期机制\n  // 在下一次初始化时，判断是否过期，来决定是否延用/清除数据\n  getCacheTime(): string | number {\n    const { time, overdue } = this;\n    // 0  false -- 不过期\n    if (!overdue || (typeof overdue === 'number' && overdue < 0)) {\n      return 'NO';\n    } else {\n      return +time + +overdue;\n    }\n  }\n}\n","// @ts-nocheck\nimport CacheTile from './CacheTool';\nimport type { TileEvent, Coords, DoneCallback } from 'leaflet';\n\nif (!L) {\n  throw new Error('please install leaflet which >1.0.0 to use the plugins');\n}\n\nlet _CacheTileObj: {[key: string]: CacheTile} = {};\n\nconst originalInitTile = L.GridLayer.prototype._initTile;\nconst originalInitialize = L.TileLayer.prototype.initialize;\nconst originalCreateTile = L.TileLayer.prototype.createTile;\n\nconst ColorCacheTile = L.TileLayer.extend({\n  initialize(url: string, options: any) {\n    options = L.extend(\n      {},\n      L.TileLayer.prototype.options,\n      {\n        // 必须是一个方法，才能保证多组不同数据传递均被接受，且不被覆盖\n        colorize(pixel: object) {\n          return pixel;\n        },\n        cacheSet(cacheOptions = {}) {\n          return cacheOptions;\n        },\n        crossOrigin: 'Anonymous'\n      },\n      options\n    );\n\n    originalInitialize.call(this, url, options);\n\n    L.setOptions(this, options);\n\n    // 初始化缓存 -- 异步获取数据，本地数据库是异步操作\n    const _cacheOptions = options.cacheSet({});\n    const _colorizeName = _cacheOptions.name || CacheTile.name;\n    const _colorizeTime = _cacheOptions.time;\n    _CacheTileObj[_colorizeName] = new CacheTile(_colorizeName, _colorizeTime);\n\n    this.setColorizr(options.colorize);\n    this.setCacheOptions(options.cacheSet);\n\n    this.on('tileload', (e: TileEvent) => {\n      const coordsValues = Object.values(e.coords).join(':');\n      this._colorize(e.tile, `${_colorizeName}/${coordsValues}`);\n    });\n  },\n  setColorizr(colorizrFactory: Function | undefined) {\n    if (!colorizrFactory || typeof colorizrFactory !== 'function') {\n      // eslint-disable-next-line max-len\n      throw `The colorize option should be a function and return an object with at least one of \"r\", \"g\", \"b\", or \"a\" properties. Got:${typeof colorizrFactory}`;\n    } else {\n      this.options.colorize = colorizrFactory;\n    }\n    this.redraw(false);\n  },\n  setCacheOptions(cacheOptionsFunc: Function | undefined) {\n    if (!cacheOptionsFunc || typeof cacheOptionsFunc !== 'function') {\n      // eslint-disable-next-line max-len\n      throw `The cacheSet option should be a function and return an object with at least one of \"name\", \"time\" properties. Got:${typeof cacheOptionsFunc}`;\n    } else {\n      this.options.cacheSet = cacheOptionsFunc;\n    }\n    this.redraw(false);\n  },\n  _initTile(tile: HTMLImageElement) {\n    originalInitTile.call(this, tile);\n\n    const tileSize = this.getTileSize();\n\n    tile.style.width = `${tileSize.x + 1}px`;\n    tile.style.height = `${tileSize.y + 1}px`;\n  },\n  createTile(coords: Coords, done: DoneCallback) {\n    const tile = originalCreateTile.call(this, coords, done);\n\n    tile.crossOrigin = 'Anonymous';\n    // tile.src = this.getTileUrl(coords);\n\n    const coordsValues = Object.values(coords).join(':');\n    const _colorizeName = this.options.cacheSet({}).name || CacheTile.name;\n    const tileCacheName = `${_colorizeName}/${coordsValues}`;\n    const catchBaseImg = _CacheTileObj[_colorizeName].getTile(tileCacheName);\n    // 异步处理数据\n    if (!catchBaseImg) {\n      tile.hidden = true;\n      tile.src = '';\n      _CacheTileObj[_colorizeName].init().then((v) => {\n        tile.src = this.getTileUrl(coords);\n        if (v.size) {\n          const _catchBaseImg = _CacheTileObj[_colorizeName].getTile(tileCacheName);\n          if (_catchBaseImg) {\n            tile.src = _catchBaseImg;\n            tile.setAttribute('color-cache-loaded', 'true');\n          }\n        }\n        done(undefined, tile);\n      });\n    } else {\n      tile.src = catchBaseImg;\n      tile.setAttribute('color-cache-loaded', 'true');\n    }\n    return tile;\n  },\n  _colorize(img: HTMLImageElement, coordsName: string) {\n    if (img.getAttribute('color-cache-loaded')) {\n      img.hidden = false;\n      return;\n    } else {\n      img.hidden = true;\n    }\n    let _img = img;\n    let newImg = new Image();\n    newImg.crossOrigin = 'Anonymous';\n    newImg.src = _img.src;\n    newImg.onload = () => {\n      let canvas = document.createElement('canvas');\n\n      canvas.width = newImg.width;\n      canvas.height = newImg.height;\n\n      let ctx = canvas.getContext('2d') as CanvasRenderingContext2D;\n\n      ctx.drawImage(newImg, 0, 0);\n\n      let imageData: ImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n\n      let pix = imageData.data;\n\n      for (let i = 0, n = pix.length; i < n; i += 4) {\n        let pixel = this.options.colorize({\n          r: pix[i],\n          g: pix[i + 1],\n          b: pix[i + 2],\n          a: pix[i + 3]\n        });\n        if (\n          !pixel ||\n          pixel !== Object(pixel) ||\n          Object.prototype.toString.call(pixel) === '[object Array]'\n        ) {\n          if (i === 0) {\n            // eslint-disable-next-line max-len\n            throw 'The colorize option should return an object with at least one of \"r\", \"g\", \"b\", or \"a\" properties.';\n          }\n        } else {\n          if (pixel.hasOwnProperty('r') && typeof pixel.r === 'number') {\n            pix[i] = pixel.r;\n          }\n          if (pixel.hasOwnProperty('g')) {\n            pix[i + 1] = pixel.g;\n          }\n          if (pixel.hasOwnProperty('b')) {\n            pix[i + 2] = pixel.b;\n          }\n          if (pixel.hasOwnProperty('a')) {\n            pix[i + 3] = pixel.a;\n          }\n        }\n      }\n      ctx.putImageData(imageData, 0, 0);\n      _img.setAttribute('color-cache-loaded', 'true');\n      const _src = canvas.toDataURL('image/webp', 0.8);\n\n      _img.src = _src;\n\n      const _colorizeName = this.options.cacheSet({}).name || CacheTile.name;\n      _CacheTileObj[_colorizeName].setTile(coordsName, _src);\n    };\n  }\n});\n\n// @ts-ignore\nL.colorCacheTile = function (url: string, options) {\n  // @ts-ignore\n  return new ColorCacheTile(url, options);\n}\n\nexport default ColorCacheTile;\n"],"names":["CacheTile","constructor","name","overdue","this","cacheMap","Map","time","Math","floor","Date","valueOf","init","async","data","checkDatabase","Promise","resolve","getTile","key","get","setTile","value","upload","set","has","updateDatabase","_time","del","getCacheTime","L","Error","_CacheTileObj","originalInitTile","GridLayer","prototype","_initTile","originalInitialize","TileLayer","initialize","originalCreateTile","createTile","ColorCacheTile","extend","url","options","colorize","pixel","cacheSet","cacheOptions","crossOrigin","call","setOptions","_cacheOptions","_colorizeName","setColorizr","setCacheOptions","on","e","coordsValues","Object","values","coords","join","_colorize","tile","colorizrFactory","redraw","cacheOptionsFunc","tileSize","getTileSize","style","width","x","height","y","done","tileCacheName","catchBaseImg","src","setAttribute","hidden","then","v","getTileUrl","size","_catchBaseImg","undefined","img","coordsName","getAttribute","_img","newImg","Image","onload","canvas","document","createElement","ctx","getContext","drawImage","imageData","getImageData","pix","i","n","length","r","g","b","a","toString","hasOwnProperty","putImageData","_src","toDataURL","colorCacheTile"],"mappings":"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"}