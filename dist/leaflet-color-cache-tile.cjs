require("leaflet");var e=require("idb-keyval"),t=/*#__PURE__*/function(){function t(e,t){this.cacheMap=new Map,this.time=Math.floor((new Date).valueOf()/1e3),this.name="cache_tile_name",this.overdue=void 0,e&&(this.name=e),this.overdue=t,this.init()}var i=t.prototype;return i.init=function(){try{var e=this;return Promise.resolve(e.checkDatabase()).then(function(t){return t&&(e.cacheMap=t),Promise.resolve(e.cacheMap)})}catch(e){return Promise.reject(e)}},i.getTile=function(e){return this.cacheMap.get(e)},i.setTile=function(e,t,i){void 0===i&&(i=!1);var r=this.cacheMap;i?r.set(e,t):r.has(e)||r.set(e,t),this.updateDatabase()},i.checkDatabase=function(){try{var t=this;return Promise.resolve(e.get(t.name)).then(function(i){var r=(new Date).valueOf()/1e3;return i?"NO"===i.time||i.time>r?i.data:(e.del(t.name),null):null})}catch(e){return Promise.reject(e)}},i.updateDatabase=function(t){try{var i=this;return void 0===t&&(t=i.cacheMap),Promise.resolve(e.set(i.name,{data:t,time:i.getCacheTime()})).then(function(){})}catch(e){return Promise.reject(e)}},i.getCacheTime=function(){var e=this.overdue;return!e||"number"==typeof e&&e<0?"NO":+this.time+ +e},t}();if(!L)throw new Error("please install leaflet which >1.0.0 to use the plugins");var i={},r=L.GridLayer.prototype._initTile,o=L.TileLayer.prototype.initialize,a=L.TileLayer.prototype.createTile,n=L.TileLayer.extend({initialize:function(e,r){var a=this;r=L.extend({},L.TileLayer.prototype.options,{colorize:function(e){return e},cacheSet:function(e){return void 0===e&&(e={}),e},crossOrigin:"Anonymous"},r),o.call(this,e,r),L.setOptions(this,r);var n=r.cacheSet({}),c=n.name||t.name;i[c]=new t(c,n.time),this.setColorizr(r.colorize),this.setCacheOptions(r.cacheSet),this.on("tileload",function(e){var t=Object.values(e.coords).join(":");a._colorize(e.tile,c+"/"+t)})},setColorizr:function(e){if(!e||"function"!=typeof e)throw'The colorize option should be a function and return an object with at least one of "r", "g", "b", or "a" properties. Got:'+typeof e;this.options.colorize=e,this.redraw(!1)},setCacheOptions:function(e){if(!e||"function"!=typeof e)throw'The cacheSet option should be a function and return an object with at least one of "name", "time" properties. Got:'+typeof e;this.options.cacheSet=e,this.redraw(!1)},_initTile:function(e){r.call(this,e);var t=this.getTileSize();e.style.width=t.x+1+"px",e.style.height=t.y+1+"px"},createTile:function(e,r){var o=this,n=a.call(this,e,r);n.crossOrigin="Anonymous";var c=Object.values(e).join(":"),s=this.options.cacheSet({}).name||t.name,h=s+"/"+c,l=i[s].getTile(h);return l?(n.src=l,n.setAttribute("color-cache-loaded","true")):(n.hidden=!0,n.src="",i[s].init().then(function(t){if(n.src=o.getTileUrl(e),t.size){var a=i[s].getTile(h);a&&(n.src=a,n.setAttribute("color-cache-loaded","true"))}r(void 0,n)})),n},_colorize:function(e,r){var o=this;if(e.getAttribute("color-cache-loaded"))e.hidden=!1;else{e.hidden=!0;var a=new Image;a.crossOrigin="Anonymous",a.src=_img.src,a.onload=function(){var e=document.createElement("canvas");e.width=a.width,e.height=a.height;var n=e.getContext("2d");n.drawImage(a,0,0);for(var c=n.getImageData(0,0,e.width,e.height),s=c.data,h=0,l=s.length;h<l;h+=4){var u=o.options.colorize({r:s[h],g:s[h+1],b:s[h+2],a:s[h+3]});if(u&&u===Object(u)&&"[object Array]"!==Object.prototype.toString.call(u))u.hasOwnProperty("r")&&"number"==typeof u.r&&(s[h]=u.r),u.hasOwnProperty("g")&&(s[h+1]=u.g),u.hasOwnProperty("b")&&(s[h+2]=u.b),u.hasOwnProperty("a")&&(s[h+3]=u.a);else if(0===h)throw'The colorize option should return an object with at least one of "r", "g", "b", or "a" properties.'}n.putImageData(c,0,0),_img.setAttribute("color-cache-loaded","true");var p=e.toDataURL("image/webp",.8);_img.src=p;var d=o.options.cacheSet({}).name||t.name;i[d].setTile(r,p)}}}});L.colorCacheTile=function(e,t){return new n(e,t)};
//# sourceMappingURL=leaflet-color-cache-tile.cjs.map
