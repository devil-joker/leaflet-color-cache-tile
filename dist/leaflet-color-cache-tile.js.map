{"version":3,"file":"leaflet-color-cache-tile.js","sources":["../src/CacheTool.ts","../src/main.ts"],"sourcesContent":["import { del, get, set } from 'idb-keyval';\n\ntype CacheDataMap = Map<string, string>;\n\nexport default class CacheTile {\n  private cacheMap: CacheDataMap = new Map();\n\n  // private time = Math.floor(new Date().valueOf() / 1000)\n  private time = Math.floor(new Date().valueOf() / 1000);\n\n  private name = 'cache_tile_name';\n\n  private overdue: number | boolean | undefined;\n\n  /**\n   *\n   * @param {string} name 储存某一类的数据名称\n   * @param {number | boolean} overdue 过期时间(s)/是否过期\n   */\n  constructor(name: string, overdue?: number | boolean) {\n    if (name) {\n      this.name = name;\n    }\n    this.overdue = overdue;\n\n    this.init();\n  }\n  // 初始化\n  async init(): Promise<CacheDataMap> {\n    const data = await this.checkDatabase();\n    if (data) {\n      this.cacheMap = data;\n    }\n    return Promise.resolve(this.cacheMap);\n  }\n  // 通过key获取map数据\n  getTile(key: string): string | undefined {\n    return this.cacheMap.get(key);\n  }\n  // 设置map数据\n  setTile(key: string, value: string, upload = false):void {\n    const { cacheMap } = this;\n    if (upload) {\n      cacheMap.set(key, value);\n    } else {\n      if (!cacheMap.has(key)) {\n        cacheMap.set(key, value);\n      }\n    }\n\n    this.updateDatabase();\n  }\n  // 检查并获取数据\n  async checkDatabase(): Promise<CacheDataMap | null> {\n    const data = await get(this.name);\n    const _time = new Date().valueOf() / 1000;\n    if (data) {\n      if (data.time === 'NO' || data.time > _time) {\n        return data.data;\n      }\n      del(this.name);\n      return null;\n    }\n    return null;\n  }\n  // 更新数据\n  async updateDatabase(data = this.cacheMap): Promise<void> {\n    const { name } = this;\n    await set(name, {\n      data,\n      time: this.getCacheTime()\n    });\n  }\n  // 时间过期机制\n  // 在下一次初始化时，判断是否过期，来决定是否延用/清除数据\n  getCacheTime(): string | number {\n    const { time, overdue } = this;\n    // 0  false -- 不过期\n    if (!overdue || (typeof overdue === 'number' && overdue < 0)) {\n      return 'NO';\n    } else {\n      return +time + +overdue;\n    }\n  }\n}\n","// @ts-nocheck\nimport CacheTile from './CacheTool';\nimport type { TileEvent, Coords, DoneCallback } from 'leaflet';\n\nif (!L) {\n  throw new Error('please install leaflet which >1.0.0 to use the plugins');\n}\n\nlet _CacheTileObj: {[key: string]: CacheTile} = {};\n\nconst originalInitTile = L.GridLayer.prototype._initTile;\nconst originalInitialize = L.TileLayer.prototype.initialize;\nconst originalCreateTile = L.TileLayer.prototype.createTile;\n\nconst ColorCacheTile = L.TileLayer.extend({\n  initialize(url: string, options: any) {\n    options = L.extend(\n      {},\n      L.TileLayer.prototype.options,\n      {\n        // 必须是一个方法，才能保证多组不同数据传递均被接受，且不被覆盖\n        colorize(pixel: object) {\n          return pixel;\n        },\n        cacheSet(cacheOptions = {}) {\n          return cacheOptions;\n        },\n        crossOrigin: 'Anonymous'\n      },\n      options\n    );\n\n    originalInitialize.call(this, url, options);\n\n    L.setOptions(this, options);\n\n    // 初始化缓存 -- 异步获取数据，本地数据库是异步操作\n    const _cacheOptions = options.cacheSet({});\n    const _colorizeName = _cacheOptions.name || CacheTile.name;\n    const _colorizeTime = _cacheOptions.time;\n    _CacheTileObj[_colorizeName] = new CacheTile(_colorizeName, _colorizeTime);\n\n    this.setColorizr(options.colorize);\n    this.setCacheOptions(options.cacheSet);\n\n    this.on('tileload', (e: TileEvent) => {\n      const coordsValues = Object.values(e.coords).join(':');\n      this._colorize(e.tile, `${_colorizeName}/${coordsValues}`);\n    });\n  },\n  setColorizr(colorizrFactory: Function | undefined) {\n    if (!colorizrFactory || typeof colorizrFactory !== 'function') {\n      // eslint-disable-next-line max-len\n      throw `The colorize option should be a function and return an object with at least one of \"r\", \"g\", \"b\", or \"a\" properties. Got:${typeof colorizrFactory}`;\n    } else {\n      this.options.colorize = colorizrFactory;\n    }\n    this.redraw(false);\n  },\n  setCacheOptions(cacheOptionsFunc: Function | undefined) {\n    if (!cacheOptionsFunc || typeof cacheOptionsFunc !== 'function') {\n      // eslint-disable-next-line max-len\n      throw `The cacheSet option should be a function and return an object with at least one of \"name\", \"time\" properties. Got:${typeof cacheOptionsFunc}`;\n    } else {\n      this.options.cacheSet = cacheOptionsFunc;\n    }\n    this.redraw(false);\n  },\n  _initTile(tile: HTMLImageElement) {\n    originalInitTile.call(this, tile);\n\n    const tileSize = this.getTileSize();\n\n    tile.style.width = `${tileSize.x + 1}px`;\n    tile.style.height = `${tileSize.y + 1}px`;\n  },\n  createTile(coords: Coords, done: DoneCallback) {\n    const tile = originalCreateTile.call(this, coords, done);\n\n    tile.crossOrigin = 'Anonymous';\n    // tile.src = this.getTileUrl(coords);\n\n    const coordsValues = Object.values(coords).join(':');\n    const _colorizeName = this.options.cacheSet({}).name || CacheTile.name;\n    const tileCacheName = `${_colorizeName}/${coordsValues}`;\n    const catchBaseImg = _CacheTileObj[_colorizeName].getTile(tileCacheName);\n    // 异步处理数据\n    if (!catchBaseImg) {\n      tile.hidden = true;\n      tile.src = '';\n      _CacheTileObj[_colorizeName].init().then((v) => {\n        tile.src = this.getTileUrl(coords);\n        if (v.size) {\n          const _catchBaseImg = _CacheTileObj[_colorizeName].getTile(tileCacheName);\n          if (_catchBaseImg) {\n            tile.src = _catchBaseImg;\n            tile.setAttribute('color-cache-loaded', 'true');\n          }\n        }\n        done(undefined, tile);\n      });\n    } else {\n      tile.src = catchBaseImg;\n      tile.setAttribute('color-cache-loaded', 'true');\n    }\n    return tile;\n  },\n  _colorize(tileImage: HTMLImageElement, coordsName: string) {\n    if (tileImage.getAttribute('color-cache-loaded')) {\n      tileImage.hidden = false;\n      return;\n    } else {\n      tileImage.hidden = true;\n    }\n    let _tileImage = tileImage;\n    let newTileImage = new Image();\n    newTileImage.crossOrigin = 'Anonymous';\n    newTileImage.src = _img.src;\n    newTileImage.onload = () => {\n      let canvas = document.createElement('canvas');\n\n      canvas.width = newTileImage.width;\n      canvas.height = newTileImage.height;\n\n      let ctx = canvas.getContext('2d') as CanvasRenderingContext2D;\n\n      ctx.drawImage(newTileImage, 0, 0);\n\n      let imageData: ImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n\n      let pix = imageData.data;\n\n      for (let i = 0, n = pix.length; i < n; i += 4) {\n        let pixel = this.options.colorize({\n          r: pix[i],\n          g: pix[i + 1],\n          b: pix[i + 2],\n          a: pix[i + 3]\n        });\n        if (\n          !pixel ||\n          pixel !== Object(pixel) ||\n          Object.prototype.toString.call(pixel) === '[object Array]'\n        ) {\n          if (i === 0) {\n            // eslint-disable-next-line max-len\n            throw 'The colorize option should return an object with at least one of \"r\", \"g\", \"b\", or \"a\" properties.';\n          }\n        } else {\n          if (pixel.hasOwnProperty('r') && typeof pixel.r === 'number') {\n            pix[i] = pixel.r;\n          }\n          if (pixel.hasOwnProperty('g')) {\n            pix[i + 1] = pixel.g;\n          }\n          if (pixel.hasOwnProperty('b')) {\n            pix[i + 2] = pixel.b;\n          }\n          if (pixel.hasOwnProperty('a')) {\n            pix[i + 3] = pixel.a;\n          }\n        }\n      }\n      ctx.putImageData(imageData, 0, 0);\n      _img.setAttribute('color-cache-loaded', 'true');\n      const _src = canvas.toDataURL('image/webp', 0.8);\n\n      _img.src = _src;\n\n      const _colorizeName = this.options.cacheSet({}).name || CacheTile.name;\n      _CacheTileObj[_colorizeName].setTile(coordsName, _src);\n    };\n  }\n});\n\n// @ts-ignore\nL.colorCacheTile = function (url: string, options) {\n  // @ts-ignore\n  return new ColorCacheTile(url, options);\n}\n\nexport default ColorCacheTile;\n"],"names":["CacheTile","name","overdue","cacheMap","time","Math","floor","Date","valueOf","this","init","_proto","prototype","_this","Promise","resolve","checkDatabase","data","e","reject","getTile","key","get","setTile","value","upload","set","has","updateDatabase","_this2","then","_time","del","_this3","undefined","getCacheTime","L","Error","_CacheTileObj","originalInitTile","GridLayer","_initTile","originalInitialize","TileLayer","initialize","originalCreateTile","createTile","ColorCacheTile","extend","url","options","colorize","pixel","cacheSet","cacheOptions","crossOrigin","call","setOptions","_cacheOptions","_colorizeName","setColorizr","setCacheOptions","on","coordsValues","Object","values","coords","join","_colorize","tile","colorizrFactory","redraw","cacheOptionsFunc","tileSize","getTileSize","style","width","x","height","y","done","tileCacheName","catchBaseImg","src","setAttribute","hidden","v","getTileUrl","size","_catchBaseImg","tileImage","coordsName","getAttribute","newTileImage","Image","_img","onload","canvas","document","createElement","ctx","getContext","drawImage","imageData","getImageData","pix","i","n","length","r","g","b","a","toString","hasOwnProperty","putImageData","_src","toDataURL","colorCacheTile"],"mappings":"gRAA2C,IAItBA,0BAenB,SAAYC,EAAAA,EAAcC,GAdlBC,KAAAA,SAAyB,QAGzBC,KAAAA,KAAOC,KAAKC,OAAM,IAAIC,MAAOC,UAAY,KAEzCP,KAAAA,KAAO,uBAEPC,aAAO,EAQTD,IACFQ,KAAKR,KAAOA,GAEdQ,KAAKP,QAAUA,EAEfO,KAAKC,MACP,CAAC,IAAAC,EAAAX,EAAAY,iBAAAD,EAEKD,KAAI,WAAA,IAAA,IAAAG,EACWJ,KAAI,OAAAK,QAAAC,QAAJF,EAAKG,+BAAlBC,GAIN,OAHIA,IACFJ,EAAKV,SAAWc,WAEHF,QAAQF,EAAKV,SAAU,EACxC,CAAC,MAAAe,GAAA,OAAAJ,QAAAK,OAAAD,EAAA,CAAA,EAAAP,EAEDS,QAAA,SAAQC,GACN,OAAOZ,KAAKN,SAASmB,IAAID,EAC3B,EAEAE,EAAAA,QAAA,SAAQF,EAAaG,EAAeC,QAAM,IAANA,IAAAA,GAAS,GAC3C,IAAgBtB,EAAKM,KAAbN,SACJsB,EACFtB,EAASuB,IAAIL,EAAKG,GAEbrB,EAASwB,IAAIN,IAChBlB,EAASuB,IAAIL,EAAKG,GAItBf,KAAKmB,gBACP,EAEMZ,EAAAA,6BACmB,IAAAa,EAAApB,KAAJa,OAAAA,QAAAA,QAAAA,EAAAA,IAAIO,EAAK5B,OAAK6B,KAAA,SAA3Bb,GACN,IAAWc,GAAG,IAAQxB,MAAGC,UAAY,IACrC,OAAIS,EACgB,OAAdA,EAAKb,MAAiBa,EAAKb,KAAO2B,EAC7Bd,EAAKA,MAEde,EAAAA,IAAIH,EAAK5B,MAEV,MACW,IAAA,EACd,CAAC,MAEK2B,GAAAA,OAAAA,QAAAA,OAAAA,EAAAA,CAAAA,EAAAA,EAAAA,wBAAeX,GAAI,IAAG,IAAAgB,EAAAxB,KACJ,YADCyB,IAAJjB,IAAAA,EAAOgB,EAAK9B,UAEzBuB,QAAAA,QAAAA,EAAAA,MADEzB,KACQ,CACdgB,KAAAA,EACAb,KAAM6B,EAAKE,oCAEf,CAAC,MAAAjB,GAAA,OAAAJ,QAAAK,OAAAD,EAAA,CAAA,EAAAP,EAGDwB,aAAA,WACE,IAAcjC,EAAYO,KAAZP,QAEd,OAAKA,GAA+B,iBAAZA,GAAwBA,EAAU,EACjD,MAHiBO,KAAlBL,OAKUF,CAEpB,OC/EF,IAAKkC,EACH,MAAM,IAASC,MAAC,0DAGlB,IAAIC,EAA4C,CAAA,EAE1CC,EAAmBH,EAAEI,UAAU5B,UAAU6B,UACzCC,EAAqBN,EAAEO,UAAU/B,UAAUgC,WACzBC,EAAGT,EAAEO,UAAU/B,UAAUkC,WAE3CC,EAAiBX,EAAEO,UAAUK,OAAO,CACxCJ,WAAWK,SAAAA,EAAaC,GAAY,IAAArC,EAAAJ,KAClCyC,EAAUd,EAAEY,OACV,CAAA,EACAZ,EAAEO,UAAU/B,UAAUsC,QACtB,CAEEC,SAASC,SAAAA,GACP,OAAOA,CACT,EACAC,SAAQ,SAACC,GACP,YADOA,IAAAA,IAAAA,EAAe,CAAA,GACfA,CACT,EACAC,YAAa,aAEfL,GAGFR,EAAmBc,KAAK/C,KAAMwC,EAAKC,GAEnCd,EAAEqB,WAAWhD,KAAMyC,GAGnB,IAAMQ,EAAgBR,EAAQG,SAAS,CAAE,GACnCM,EAAgBD,EAAczD,MAAQD,EAAUC,KAEtDqC,EAAcqB,GAAiB,IAAa3D,EAAC2D,EADvBD,EAActD,MAGpCK,KAAKmD,YAAYV,EAAQC,UACzB1C,KAAKoD,gBAAgBX,EAAQG,UAE7B5C,KAAKqD,GAAG,WAAY,SAAC5C,GACnB,IAAkB6C,EAAGC,OAAOC,OAAO/C,EAAEgD,QAAQC,KAAK,KAClDtD,EAAKuD,UAAUlD,EAAEmD,KAASV,EAAa,IAAII,EAC7C,EACF,EACAH,YAAYU,SAAAA,GACV,IAAKA,GAA8C,mBAApBA,EAE7B,KAAA,mIAAyIA,EAEzI7D,KAAKyC,QAAQC,SAAWmB,EAE1B7D,KAAK8D,QAAO,EACd,EACAV,gBAAe,SAACW,GACd,IAAKA,GAAgD,mBAALA,EAE9C,KAAA,4HAAkIA,EAElI/D,KAAKyC,QAAQG,SAAWmB,EAE1B/D,KAAK8D,QAAO,EACd,EACA9B,UAAS,SAAC4B,GACR9B,EAAiBiB,KAAK/C,KAAM4D,GAE5B,IAAMI,EAAWhE,KAAKiE,cAEtBL,EAAKM,MAAMC,MAAWH,EAASI,EAAI,EAAK,KACxCR,EAAKM,MAAMG,OAAYL,EAASM,EAAI,EAAC,IACvC,EACAjC,WAAWoB,SAAAA,EAAgBc,GAAkB,IAAAnD,EAAApB,KACrC4D,EAAOxB,EAAmBW,KAAK/C,KAAMyD,EAAQc,GAEnDX,EAAKd,YAAc,YAGnB,IAAMQ,EAAeC,OAAOC,OAAOC,GAAQC,KAAK,KAC1CR,EAAgBlD,KAAKyC,QAAQG,SAAS,CAAE,GAAEpD,MAAQD,EAAUC,KAC5DgF,EAAmBtB,EAAiBI,IAAAA,EACxBmB,EAAG5C,EAAcqB,GAAevC,QAAQ6D,GAoB1D,OAlBKC,GAeHb,EAAKc,IAAMD,EACXb,EAAKe,aAAa,qBAAsB,UAfxCf,EAAKgB,QAAS,EACdhB,EAAKc,IAAM,GACX7C,EAAcqB,GAAejD,OAAOoB,KAAK,SAACwD,GAExC,GADAjB,EAAKc,IAAMtD,EAAK0D,WAAWrB,GACvBoB,EAAEE,KAAM,CACV,IAAMC,EAAgBnD,EAAcqB,GAAevC,QAAQ6D,GACvDQ,IACFpB,EAAKc,IAAMM,EACXpB,EAAKe,aAAa,qBAAsB,QAE3C,CACDJ,OAAK9C,EAAWmC,EAClB,IAKKA,CACT,EACAD,UAAS,SAACsB,EAA6BC,GACrC,IAAA1D,EAAAxB,KAAA,GAAIiF,EAAUE,aAAa,sBACzBF,EAAUL,QAAS,MADrB,CAIEK,EAAUL,QAAS,EAGrB,IAAIQ,EAAe,IAAWC,MAC9BD,EAAatC,YAAc,YAC3BsC,EAAaV,IAAMY,KAAKZ,IACxBU,EAAaG,OAAS,WACpB,IAAUC,EAAGC,SAASC,cAAc,UAEpCF,EAAOrB,MAAQiB,EAAajB,MAC5BqB,EAAOnB,OAASe,EAAaf,OAE7B,IAAIsB,EAAMH,EAAOI,WAAW,MAE5BD,EAAIE,UAAUT,EAAc,EAAG,GAM/B,IAJA,IAAaU,EAAcH,EAAII,aAAa,EAAG,EAAGP,EAAOrB,MAAOqB,EAAOnB,QAEnE2B,EAAMF,EAAUtF,KAEXyF,EAAI,EAAGC,EAAIF,EAAIG,OAAQF,EAAIC,EAAGD,GAAK,EAAG,CAC7C,IAAStD,EAAGnB,EAAKiB,QAAQC,SAAS,CAChC0D,EAAGJ,EAAIC,GACPI,EAAGL,EAAIC,EAAI,GACXK,EAAGN,EAAIC,EAAI,GACXM,EAAGP,EAAIC,EAAI,KAEb,GACGtD,GACDA,IAAUY,OAAOZ,IACyB,mBAA1CY,OAAOpD,UAAUqG,SAASzD,KAAKJ,GAO3BA,EAAM8D,eAAe,MAA2B,iBAAZ9D,EAAMyD,IAC5CJ,EAAIC,GAAKtD,EAAMyD,GAEbzD,EAAM8D,eAAe,OACvBT,EAAIC,EAAI,GAAKtD,EAAM0D,GAEjB1D,EAAM8D,eAAe,OACvBT,EAAIC,EAAI,GAAKtD,EAAM2D,GAEjB3D,EAAM8D,eAAe,OACvBT,EAAIC,EAAI,GAAKtD,EAAM4D,QAfrB,GAAU,IAANN,EAEF,KAAM,oGAgBX,CACDN,EAAIe,aAAaZ,EAAW,EAAG,GAC/BR,KAAKX,aAAa,qBAAsB,QACxC,IAAMgC,EAAOnB,EAAOoB,UAAU,aAAc,IAE5CtB,KAAKZ,IAAMiC,EAEX,IAAmBzD,EAAG1B,EAAKiB,QAAQG,SAAS,CAAA,GAAIpD,MAAQD,EAAUC,KAClEqC,EAAcqB,GAAepC,QAAQoE,EAAYyB,EACnD,CA1DC,CA2DH,IAIFhF,EAAEkF,eAAiB,SAAUrE,EAAaC,GAExC,OAAWH,IAAAA,EAAeE,EAAKC,EACjC"}